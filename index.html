<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Etiquetas PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
    <h1>Generador de Etiquetas PDF</h1>
    <iframe id="pdfFrame" style="width: 100%; height: 100vh; border: none;"></iframe>

    <script>

        function generateBarcodeUrl(codigo) {
            const baseUrl = "https://barcode.tec-it.com/barcode.ashx?";
            const params = new URLSearchParams({
                code: "Code128",
                data: encodeURIComponent(codigo),
                dpi: "96",
                imagetype: "png",
                rotation: "0",
                eclevel: "L",
                dmsize: "Default"
            });
            return `${baseUrl}${params.toString()}`;
        }
        
        async function generatePdf() {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;

            // Parámetros obtenidos de la URL
            const params = new URLSearchParams(window.location.search);
            const codigoProducto = params.get('codigo');
            const precioProducto = params.get('precio');
            const nombreProducto = params.get('nombre');
            const descripcionProducto = params.get('descripcion');

            // Crear un nuevo documento PDF
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([3.3 * 72, 1.8 * 72]);

            // Cargar una fuente estándar
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

            // Logo en la parte superior izquierda
            try {
                const logoBytes = await fetch('LOGO.jpeg').then(res => res.arrayBuffer());
                const logoImage = await pdfDoc.embedPng(logoBytes);
                page.drawImage(logoImage, { x: 2, y: 90, width: 90, height: 35 });
            } catch (error) {
                console.error("Error loading logo:", error);
            }

            // Precio en la parte superior derecha
            page.drawText(`$${parseFloat(precioProducto).toFixed(2)}`, {
                x: 130,
                y: 108,
                size: 16,
                font,
                color: rgb(0, 0, 0),
            });

            // Nombre del producto
            page.drawText(nombreProducto, {
                x: 2,
                y: 74,
                size: 12,
                font,
                color: rgb(0, 0, 0),
            });

            // Descripción del producto
            page.drawText(descripcionProducto, {
                x: 2,
                y: 60,
                size: 12,
                font,
                color: rgb(0, 0, 0),
            });

            // Obtener la URL del código de barras
            const barcodeUrl = generateBarcodeUrl(codigoProducto);

            try {
                const barcodeBytes = await fetch(barcodeUrl).then(res => res.arrayBuffer());
                const barcodeImage = await pdfDoc.embedPng(barcodeBytes);
                page.drawImage(barcodeImage, { x: 72, y: 5, width: 100, height: 20 });
            } catch (error) {
                console.error("Error loading barcode:", error);
            }

            // Serializar el PDF a bytes
            const pdfBytes = await pdfDoc.save();

            // Mostrar el PDF en el iframe
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            document.getElementById('pdfFrame').src = url;
        }        

        // Ejecutar la función de generación de PDF al cargar la página
        window.onload = generatePdf;
    </script>
</body>
</html>
